# 青萍设备公有 MQTT 通讯协议

## 1. 私有化支持

## 2. MQTT 通讯协议

### 2.1 规则说明

- 所有命令和应答以 Json 格式通信；
- MQTT Topic 规范，各设备支持上行、下行两个方向的数据通信，分别设置对应 Topic。对于私有化用户，上行和下行 Topics 可以使用默认值或也可自行设定，自定义的可以在上一节进行。
  - 上行 Topic 说明：用于设备发布属性、事件或其他拓展信息
  - 下行 Topic 说明：用于设备获取云端下发的设备配置或其他动作指令

### 2.2 Json 数据包字段及格式说明

下表列出所有可能字段，不同产品设备支持会有不同，请根据实际情况可选查看

| 属性        | 类型   | 描述                                                                                |
| ----------- | ------ | ----------------------------------------------------------------------------------- |
| type        | 数值   | 通讯命令类型（支持命令类型说明如下）                                                |
| mac         | 字符串 | BLE MAC 地址                                                                        |
| buffer      | 字符串 | BLE 数据内容                                                                        |
| length      | 数值   | BLE 数据内容长度                                                                    |
| srv_uuid    | 字符串 | BLE 服务 UUID                                                                       |
| chr_uuid    | 字符串 | BLE 特征 UUID                                                                       |
| adv_data    | 字符串 | BLE 广播数据                                                                        |
| rssi        | 数值   | 信号强度                                                                            |
| timeout     | 数值   | 连接超时时间（单位秒），默认连接成功后10秒没有任何数据命令通信则断开连接            |
| sw_version  | 字符串 | 软件版本                                                                            |
| wifi_info   | 字符串 | 当前连接的 Wi-Fi 信息，如：SSID，信号强度，信道，Wi-Fi，MAC                         |
| up_itvl     | 数值   | 临时上报间隔（单位秒）                                                              |
| duration    | 数值   | 临时上报持续时间（单位秒）                                                          |
| dev_list    | 数组   | 设备列表                                                                            |
| mqtt_cfg    | 结构体 | MQTT配置（host, port, usrname, password, clientid, subscribe_topic, publish_topic） |
| wifi_cfg    | 结构体 | Wi-Fi 配置（SSID, PASSWORD）                                                        |
| sensor_data | 结构体 | 设备传感器采集的数据（格式说明如下）                                                |
| setting     | 结构体 | 传感器采集间隔、上报间隔等（设备配置格式说明如下）                                  |
| timestamp   | 数值   | 时间戳（单位秒）                                                                    |
| result      | 数值   | 命令执行结果（支持命令类型说明如下）                                                |

### 2.2.1 设备传感器采集数据格式说明

| 属性        | 类型   | 单位     | 描述                   |
| ----------- | ------ | -------- | ---------------------- |
| battery     | 结构体 | %        | 电池电量百分比         |
| temperature | 结构体 | 摄氏度 C | 温度（算法补偿后的值） |
| humidity    | 结构体 | %        | 湿度百分比             |
| pm1         | 结构体 | ppm      | PM1                    |
| pm25        | 结构体 | ppm      | PM2.5                  |
| pm10        | 结构体 | ppm      | PM10                   |
| co2         | 结构体 | ppm      | 二氧化碳               |
| tvoc        | 结构体 | ppm      | TVOC                   |
| radon       | 结构体 | ppm      | 氡                     |

### 2.2.2 设备传感器采集数据格式子结构体说明

| 属性   | 类型   | 描述                                                                                                                 |
| ------ | ------ | -------------------------------------------------------------------------------------------------------------------- |
| value  | 数值   | 数值使用默认单位上报，不根据单位切换而改变                                                                           |
| status | 数值   | 0：正常（正常时可无该字段），在battery里表示放电<br>1：异常，在battery里表示充电<br>2： 初始化， 在battery里表示满电 |
| level  | 数值   | 传感器检测结果等级（部分传感器会有）                                                                                 |
| unit   | 字符串 | 单位                                                                                                                 |

### 2.2.3 设备配置格式说明

| 属性                  | 类型   | 单位 | 描述                                     |
| --------------------- | ------ | ---- | ---------------------------------------- |
| report_interval       | 数值   | 秒   | 传感器数据上报周期                       |
| collect_interval      | 数值   | 秒   | 传感器数据采样间隔                       |
| co2_sampling_interval | 数值   | 秒   | CO2 传感器采样间隔                       |
| pm_sampling_interval  | 数值   | 秒   | PM2.5 PM10 传感器采样间隔                |
| temperature_unit      | 字符串 | -    | 温度单位设置                             |
| night_mode_start_time | 数值   | 秒   | 夜间模式开始事件，为从0点0分开始的分钟数 |
| night_mode_end_time   | 数值   | 秒   | 夜间模式结束时间,为从0点0分开始的分钟数  |

### 2.2.4 命令支持列表说明

| 值     | 描述                                                   |
| ------ | ------------------------------------------------------ |
| 1      | 服务端发起BLE连接                                      |
| 2      | 服务端断开BLE连接                                      |
| 3      | 服务端打开BLE通知                                      |
| 4      | 服务端关闭BLE通知                                      |
| 5      | 设备端BLE通知数据返回                                  |
| 6      | 服务端发送BLE数据(with response)                       |
| 7      | 服务端读取BLE数据                                      |
| 8      | 设备端BLE读数据返回                                    |
| 9      | 设备端返回广播数据                                     |
| 10     | 设备端获取设备列表                                     |
| 11     | 服务端返回设备列表                                     |
| 12     | 服务端设置临时广播上报间隔和持续时间                   |
| 13     | 心跳包                                                 |
| 14     | 重连MQTT                                               |
| 15     | 服务端发送BLE数据(without response)                    |
| 16     | 修改 Mqtt 连接信息                                     |
| 17     | 修改上报频率                                           |
| 12和17 | 传感器数据上报（12表示实时数据，17表示定时(历史)数据） |
| 18     | 服务端收到定时(历史)数据（type为17）上报后应答         |
| 19     | 上报设备日志                                           |
| 20     | 绑定状态                                               |
| 23     | 服务端发送OTA命令                                      |
| 24     | 设备端接收到OTA命令后回复                              |
| 25     | 设备端获取设备列表(带设备名)                           |
| 26     | 服务端返回设备列表(带设备名)                           |

### 2.2.5 命令执行结果状态支持列表说明

| 值  | 描述            |
| --- | --------------- |
| 1   | 成功            |
| -1  | 连接超时        |
| -2  | 蓝牙忙碌        |
| -3  | 写数据失败      |
| -4  | 读数据失败      |
| -5  | 打开BLE通知失败 |
| -6  | 关闭BLE通知失败 |
| -7  | 非绑定设备      |
| -8  | 连接异常        |
| -9  | 当前设备未连接  |
| -10 | Sparrow未绑定   |
