# 青萍空气检测仪私有化接入说明

- [青萍空气检测仪私有化接入说明](#青萍空气检测仪私有化接入说明)
  - [1. 定义](#1-定义)
  - [2. 产品](#2-产品)
  - [3. 接入指南](#3-接入指南)
    - [3.1 接入方式](#31-接入方式)
    - [3.2 接入阿里 IoT 平台](#32-接入阿里-iot-平台)
      - [3.2.1 参数配置](#321-参数配置)
      - [3.2.2 创建产品](#322-创建产品)
      - [3.2.3 RAM 访问控制](#323-ram-访问控制)
    - [3.2 自建 MQTT 服务](#32-自建-mqtt-服务)
  - [4. 数据通信协议](#4-数据通信协议)
    - [4.1 修改设备上报频率配置](#41-修改设备上报频率配置)
    - [4.2 设备上报数据格式](#42-设备上报数据格式)
    - [4.3 应答格式](#43-应答格式)

## 1. 定义

设备私有化，指通过配置设备的 MQTT 地址、入网凭证等信息，以将设备注册到与客户平台，实现设备直接与客户平台进行通信的目的。  
***说明：*** 目前空气检测仪有部分功能是通过 HTTP 实现的，如：室外天气、定位、时间、固件升级等，考虑到这块私有化的难度，所以暂时不支持私有化，如果有需求请联系我们具体沟通

## 2. 产品

| 产品             | 是否支持设备私有化 | 固件版本          |
| ---------------- | ------------------ | ----------------- |
| 青萍空气检测仪   | 是                 | 3.4.5_0148 及以上 |
| 青萍空气检测仪 S | 是                 | 全部支持          |

## 3. 接入指南

### 3.1 接入方式

产品支持：阿里 IoT 和自建 MQTT 接入两种方式。

### 3.2 接入阿里 IoT 平台

#### 3.2.1 参数配置

将以下参数在青萍后台进行配置

| 参数          | 说明                                                                                                          |
| ------------- | ------------------------------------------------------------------------------------------------------------- |
| REGION ID     | 开通的是哪个区域的物联网平台服务                                                                              |
| ACCESS KEY    | RAM 访问控制中创建一个用户并为其设置“管理物联网平台(IoT)的权限”，得到 AccessKey 和 AccessSecret（参考 3.2.3） |
| ACCESS SECRET | 如上                                                                                                          |
| PRODUCT KEY   | 阿里物联网平台创建产品，得到 ProductKey（参考 3.2.2）                                                         |

#### 3.2.2 创建产品

- 创建产品：所属品类（自定义品类）、节点类型（直连设备）、联网方式（Wi-Fi）、数据格式（透传/自定义）、认证方式（设备密钥）。
- 创建完成后，列表中可看到 ProductKey。

#### 3.2.3 RAM 访问控制

- 创建一个用户并添加“管理物联网平台（IoT）的权限”。
- 点击用户信息详情，认证管理中“创建 AccessKey”，得到 AccessKey 和 AccessSecret。

### 3.2 自建 MQTT 服务

需客户提供 API 支持为每台设备下发以下参数，

| 参数           | 说明                                                                                |
| -------------- | ----------------------------------------------------------------------------------- |
| host           | MQTT 服务地址（IP地址:Port端口号）                                                  |
| port           | 端口                                                                                |
| username       | 用户名                                                                              |
| password       | 密码                                                                                |
| clientId       | 客户 id                                                                             |
| publishTopic   | 向设备下发命令主题（默认格式：qingping/{mac}/down，其中 mac 为每个设备的 MAC 地址） |
| subscribeTopic | 设备上报数据主题（默认格式：qingping/{mac}/up，其中 mac 为每个设备的 MAC 地址）     |

## 4. 数据通信协议

### 4.1 修改设备上报频率配置

通信协议格式请参考 [青萍设备公有 MQTT 通讯协议 - 3.16 修改上报频率](/main/private/public_mqtt#316-修改上报频率)

### 4.2 设备上报数据格式

设备上报的数据格式请参考 [青萍设备公有 MQTT 通讯协议 - 3.17 传感器数据](/main/private/public_mqtt#317-传感器数据)

### 4.3 应答格式

收到设备上报数据后，或设备收到下发的配置修改命令后都会进行应答，以确认数据或命令被正常收到，确认应答格式请参考 [青萍设备公有 MQTT 通讯协议 - 3.18 服务端及设备端应答格式](/main/private/public_mqtt#318-服务端及设备端应答格式)
